<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trade Calculator</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Bree+Serif&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet" />

  <!-- Meta Tags for SEO -->
  <meta name="description" content="Trade Calculator">
  <meta name="keywords" content="dynasty fantasy football, dynasty tools, mock drafts, trade calculator, college development players, fantasy football analysis, devy, sleeper, dynasty toolbox">

  <!-- Open Graph Tags -->
  <meta property="og:title" content="Trade Calculator – Dynasty Fantasy Football Analysis & Tools">
  <meta property="og:description" content="Explore comprehensive dynasty fantasy football analysis, mock drafts, trade calculators, and more.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://www.dynasty-toolbox.com">
  <meta property="og:image" content="https://www.dynasty-toolbox.com/path/to/your-logo.png">

  <!-- Twitter Card Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Trade Calculator – Dynasty Fantasy Football Analysis & Tools">
  <meta name="twitter:description" content="Explore comprehensive dynasty fantasy football analysis, mock drafts, trade calculators, and more.">
  <meta name="twitter:image" content="https://www.dynasty-toolbox.com/path/to/your-logo.png">

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-1C5TVEGFXT"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-1C5TVEGFXT');
  </script>

  <style>
    /* ---------- Header & Nav Styles ---------- */
    body {
      font-family: 'Bree Serif', serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    nav a {
      margin: 0 10px;
      text-decoration: none;
      color: #004d40;
      font-weight: bold;
    }

    /* ---------- Trade Calculator Styles ---------- */
    .trade-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 20px;
      padding: 20px;
    }
    .trade-box {
      flex: 0 0 400px;
      width: 100%;
      max-width: 400px;
      background: #ffffff;
      border: 2px solid #004d40;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      padding: 20px;
      text-align: left;
    }
    @media (max-width: 700px) {
      .trade-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .trade-header select {
        width: 100%;
        max-width: none;
      }
      .remove-team-btn {
        padding: 6px 12px;
        font-size: 0.9em;
      }
    }
    .trade-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 1.3em;
      font-weight: bold;
      color: #004d40;
      margin-bottom: 10px;
    }
    .trade-header select {
      font-size: 1em;
      padding: 5px;
      border-radius: 6px;
      border: 1px solid #004d40;
      background: #e0f2f1;
      color: #004d40;
    }
    .player-search {
      width: calc(100% - 10px);
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1em;
      margin-bottom: 10px;
    }
    .trade-sends {
      position: relative;
    }
    .suggestions-box {
      position: absolute;
      top: 45px;
      left: 0;
      width: calc(100% - 20px);
      background: white;
      border: 1px solid #004d40;
      border-radius: 6px;
      box-shadow: 0px 4px 8px rgba(0,0,0,0.2);
      z-index: 10;
      display: none;
    }
    .suggestion-item {
      padding: 8px;
      cursor: pointer;
      color: #004d40;
      font-weight: bold;
    }
    .suggestion-item:hover {
      background: #80cbc4;
      color: white;
    }
    .trade-list {
      list-style-type: none;
      padding: 0;
      margin: 10px 0;
    }
    .trade-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #e0f2f1;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 5px;
    }
    .trade-item .player-score {
      flex-shrink: 0;
      margin-left: 10px;
    }
    .dest-select {
      padding: 4px;
      border-radius: 4px;
      border: 1px solid #004d40;
      background: #e0f2f1;
      color: #004d40;
      font-weight: bold;
      margin-left: 8px;
    }
    .remove-btn {
      background: #d32f2f;
      color: white;
      border: none;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      font-size: 1em;
      cursor: pointer;
      margin-left: 8px;
    }
    .remove-btn:hover {
      background: #ff5252;
    }
    .remove-team-btn {
      background: #d32f2f;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 0.8em;
      cursor: pointer;
      margin-left: 10px;
    }
    .remove-team-btn:hover {
      background: #ff5252;
    }
    .trade-totals p {
      margin: 5px 0;
      font-weight: bold;
    }
    .trade-total.positive {
      color: green;
    }
    .trade-total.negative {
      color: red;
    }
    /* bonus row in the sends list */
    .bonus-item {
      background: #fff3e0;
      border-left: 4px solid #ff9800;
      font-style: italic;
      margin-bottom: 5px;
    }
    /* Add Team button styling */
    #addTeamContainer {
      margin-bottom: 20px;
    }
    #addTeamButton {
      padding: 10px 20px;
      font-size: 1em;
      background: #004d40;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #addTeamButton:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <!-- ---------- Header & Nav ---------- -->
  <header>
    <div class="top-bar">
      <div class="social-links">
        <a href="https://instagram.com/dynastytoolbox" target="_blank" aria-label="Instagram"><img src="/assets/icons/instagram.svg" alt=""></a>
        <a href="https://x.com/dynastytoolbox" target="_blank" aria-label="X"><img src="/assets/icons/x.png" alt=""></a>
        <a href="https://tiktok.com/@dynastytoolbox" target="_blank" aria-label="TikTok"><img src="/assets/icons/tiktok.svg" alt=""></a>
      </div>
    </div>
    <h1>Trade Calculator</h1>
  </header>

  <div id="nav-placeholder"></div>

  <div class="explanation-note">
    <p>
      We use <strong>three</strong> ranking systems on this page:
      <em>Overall</em> is our best reflection of true dynasty value,
      while <em>Competing</em> and <em>Tanking</em> are more “value‑to‑you” systems
      Competing if you’re chasing a title today, Tanking if you’re rebuilding for the future.
      For the Trade Calculator, you can set each team's ranking system individually.
    </p>
  </div>

  <main>
    <div class="trade-container" id="tradeContainer">
      <!-- Team 1 -->
      <div class="trade-box" id="team1Box">
        <div class="trade-header">
          <span>Team 1</span>
          <select id="team1Status">
            <option value="overall">Overall</option>
            <option value="competing">Competing</option>
            <option value="tanking">Tanking</option>
          </select>
          <button class="remove-team-btn" onclick="removeTeam(1)">Remove Team</button>
        </div>
        <div class="trade-sends">
          <h3>Sends:</h3>
          <input type="text" id="team1PlayerInput" class="player-search" placeholder="Search for a player" />
          <div id="team1Suggestions" class="suggestions-box"></div>
          <ul id="team1Sends" class="trade-list"></ul>
        </div>
        <div class="trade-receives">
          <h3>Receives:</h3>
          <ul id="team1Receives" class="trade-list"></ul>
        </div>
        <div class="trade-totals">
          <p>Sends Total: <span id="team1SendsTotal">0</span></p>
          <p>Receives Total: <span id="team1ReceivesTotal">0</span></p>
          <p>Trade Total: <span id="team1TradeTotal" class="trade-total">0</span></p>
        </div>
      </div>
      <!-- Team 2 -->
      <div class="trade-box" id="team2Box">
        <div class="trade-header">
          <span>Team 2</span>
          <select id="team2Status">
            <option value="overall">Overall</option>
            <option value="competing">Competing</option>
            <option value="tanking">Tanking</option>
          </select>
          <button class="remove-team-btn" onclick="removeTeam(2)">Remove Team</button>
        </div>
        <div class="trade-sends">
          <h3>Sends:</h3>
          <input type="text" id="team2PlayerInput" class="player-search" placeholder="Search for a player" />
          <div id="team2Suggestions" class="suggestions-box"></div>
          <ul id="team2Sends" class="trade-list"></ul>
        </div>
        <div class="trade-receives">
          <h3>Receives:</h3>
          <ul id="team2Receives" class="trade-list"></ul>
        </div>
        <div class="trade-totals">
          <p>Sends Total: <span id="team2SendsTotal">0</span></p>
          <p>Receives Total: <span id="team2ReceivesTotal">0</span></p>
          <p>Trade Total: <span id="team2TradeTotal" class="trade-total">0</span></p>
        </div>
      </div>
    </div>
    <div id="addTeamContainer">
      <button id="addTeamButton">Add Team</button>
    </div>
  </main>

  <script>
    /********** Globals **********/
    let teams = [1, 2];
    let nextTeamNumber = 3;
    const maxTeams = 12;
    const csvUrls = {
      competing:
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQPMs1DdGgohxRyuKn95x0xIXNOmMLhFFlAf7Bh4yym02mISdp1sp_XrtmAVJwoxcOsSyls_4as-Yi8/pub?gid=0&single=true&output=csv",
      overall:
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQPMs1DdGgohxRyuKn95x0xIXNOmMLhFFlAf7Bh4yym02mISdp1sp_XrtmAVJwoxcOsSyls_4as-Yi8/pub?gid=116299513&single=true&output=csv",
      tanking:
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQPMs1DdGgohxRyuKn95x0xIXNOmMLhFFlAf7Bh4yym02mISdp1sp_XrtmAVJwoxcOsSyls_4as-Yi8/pub?gid=1543093851&single=true&output=csv"
    };
    let playerData = {};
    let selectedPlayers = { 1: [], 2: [] };

    async function loadAllPlayers() {
      for (const [status, url] of Object.entries(csvUrls)) {
        try {
          const res = await fetch(url);
          const rows = (await res.text()).split("\n").map(r => r.split(","));
          playerData[status] = rows.slice(1).map(r => ({ name: r[1], score: r[4] }));
        } catch (e) {
          console.error(`Error loading ${status}:`, e);
        }
      }
    }

    /********** Utility **********/
    function rebuildDestOptions() {
      document.querySelectorAll(".trade-item").forEach(li => {
        const from = li.dataset.from;
        const sel = li.querySelector(".dest-select");
        if (!sel) return;
        const old = sel.value;
        sel.innerHTML = teams
          .filter(t => String(t) !== from)
          .map(t => `<option value="${t}"${t==old?" selected":""}>Team ${t}</option>`)
          .join("");
      });
    }

    /********** Update send scores **********/
    function updateSendScores(team) {
      const status = document.getElementById(`team${team}Status`).value;
      document.querySelectorAll(`#team${team}Sends .trade-item`).forEach(item => {
        const name = item.dataset.name;
        const score = playerData[status].find(p => p.name === name)?.score || "0";
        item.querySelector(".player-score").textContent = score;
      });
      updateReceives();
    }

    /********** Update receives **********/
    function updateReceives() {
      teams.forEach(dest => {
        const list = document.getElementById(`team${dest}Receives`);
        list.innerHTML = "";
        teams.forEach(src => {
          if (src === dest) return;
          document.querySelectorAll(`#team${src}Sends .trade-item`).forEach(li => {
            if (li.dataset.dest === String(dest)) {
              const name = li.dataset.name;
              const score = playerData[document.getElementById(`team${dest}Status`).value]
                .find(p => p.name === name)?.score || "0";
              const el = document.createElement("li");
              el.className = "trade-item";
              el.innerHTML = `${name} <span class="player-score">${score}</span>`;
              list.appendChild(el);
            }
          });
        });
      });
      updateTotals();
    }

    /********** Replacement‑based bonus (sends only) **********/
    function computeBonus(sVals, rVals) {
      // no bonus if nothing sent or <=1 received
      if (!sVals.length || rVals.length <= 1) return 0;
      const sMax = Math.max(...sVals),
            rMax = Math.max(...rVals),
            threshold = 750;
      // only bonus when your top‐send exceeds every received asset by threshold
      if (sMax > rMax + threshold) {
        const packageCount = rVals.length;
        const scale = 1 - 1/Math.sqrt(packageCount + 1);
        return rMax * scale;
      }
      return 0;
    }

    /********** Update totals with bonus **********/
    function updateTotals() {
      teams.forEach(team => {
        const sEls = document.querySelectorAll(`#team${team}Sends .player-score`);
        const rEls = document.querySelectorAll(`#team${team}Receives .player-score`);
        const sVals = Array.from(sEls).map(e => parseFloat(e.textContent) || 0);
        const rVals = Array.from(rEls).map(e => parseFloat(e.textContent) || 0);
        const rawS = sVals.reduce((a,b)=>a+b,0);
        const rawR = rVals.reduce((a,b)=>a+b,0);

        const bonus = computeBonus(sVals, rVals);
        const finalS = rawS + bonus;

        // inject/remove bonus under Sends
        const sList = document.getElementById(`team${team}Sends`);
        sList.querySelectorAll(".bonus-item").forEach(e=>e.remove());
        if (bonus > 0) {
          const li = document.createElement("li");
          li.className = "trade-item bonus-item";
          li.innerHTML = `Bonus <span class="player-score">${bonus.toFixed(2)}</span>`;
          sList.insertBefore(li, sList.children[1]);
        }

        document.getElementById(`team${team}SendsTotal`).textContent    = finalS.toFixed(2);
        document.getElementById(`team${team}ReceivesTotal`).textContent = rawR.toFixed(2);
        const diffTotal = rawR - finalS;
        const el = document.getElementById(`team${team}TradeTotal`);
        el.textContent = diffTotal.toFixed(2);
        el.classList.remove("positive","negative");
        if (diffTotal>0) el.classList.add("positive");
        if (diffTotal<0) el.classList.add("negative");
      });
    }

    /********** Add / Remove Players **********/
    function addPlayerToTeam(team, name) {
      const status = document.getElementById(`team${team}Status`).value;
      const player = playerData[status].find(p=>p.name===name);
      if (!player || selectedPlayers[team].includes(name)) return;
      selectedPlayers[team].push(name);

      const li = document.createElement("li");
      li.className = "trade-item";
      li.dataset.name = name;
      li.dataset.from = team;
      li.dataset.dest = teams.find(t=>t!==team);
      li.innerHTML = `
        ${name} <span class="player-score">${player.score}</span>
        <select class="dest-select" onchange="destinationChanged(${team},'${name}',this)"></select>
        <button class="remove-btn" onclick="removePlayerFromTeam(${team},'${name}')">✖</button>
      `;
      document.getElementById(`team${team}Sends`).appendChild(li);
      rebuildDestOptions();
      document.getElementById(`team${team}PlayerInput`).value = "";
      document.getElementById(`team${team}Suggestions`).style.display = "none";
      updateReceives();
    }

    function destinationChanged(from, name, sel) {
      document.querySelector(`#team${from}Sends [data-name='${name}']`)
        .dataset.dest = sel.value;
      updateReceives();
    }

    function removePlayerFromTeam(team, name) {
      selectedPlayers[team] = selectedPlayers[team].filter(p=>p!==name);
      document.querySelector(`#team${team}Sends [data-name='${name}']`).remove();
      updateReceives();
    }

    /********** Autocomplete **********/
    function handleSearchInput(team) {
      const q = document.getElementById(`team${team}PlayerInput`).value.trim().toLowerCase();
      const box = document.getElementById(`team${team}Suggestions`);
      box.innerHTML = ""; box.style.display = q?"block":"none";
      if (!q) return;
      const status = document.getElementById(`team${team}Status`).value;
      playerData[status]
        .filter(p=>p.name.toLowerCase().includes(q))
        .slice(0,5)
        .forEach(p=>{
          const d = document.createElement("div");
          d.className="suggestion-item";
          d.innerText=p.name;
          d.onclick=()=>addPlayerToTeam(team,p.name);
          box.appendChild(d);
        });
    }

    /********** Dynamic Teams **********/
    function createTeamBox(num) {
      return `
      <div class="trade-box" id="team${num}Box">
        <div class="trade-header">
          <span>Team ${num}</span>
          <select id="team${num}Status">
            <option value="overall">Overall</option>
            <option value="competing">Competing</option>
            <option value="tanking">Tanking</option>
          </select>
          <button class="remove-team-btn" onclick="removeTeam(${num})">Remove Team</button>
        </div>
        <div class="trade-sends">
          <h3>Sends:</h3>
          <input type="text" id="team${num}PlayerInput" class="player-search" placeholder="Search for a player"/>
          <div id="team${num}Suggestions" class="suggestions-box"></div>
          <ul id="team${num}Sends" class="trade-list"></ul>
        </div>
        <div class="trade-receives">
          <h3>Receives:</h3>
          <ul id="team${num}Receives" class="trade-list"></ul>
        </div>
        <div class="trade-totals">
          <p>Sends Total: <span id="team${num}SendsTotal">0</span></p>
          <p>Receives Total: <span id="team${num}ReceivesTotal">0</span></p>
          <p>Trade Total: <span id="team${num}TradeTotal" class="trade-total">0</span></p>
        </div>
      </div>`;
    }

    function attachTeamListeners(team) {
      document.getElementById(`team${team}Status`)
        .addEventListener("change", ()=>{ updateSendScores(team); updateReceives(); });
      document.getElementById(`team${team}PlayerInput`)
        .addEventListener("input", ()=>handleSearchInput(team));
      if (!selectedPlayers[team]) selectedPlayers[team] = [];
    }

    function updateRemoveButtons() {
      teams.forEach(t => {
        const btn = document.querySelector(`#team${t}Box .remove-team-btn`);
        btn.style.display = teams.length > 2 ? "inline-block" : "none";
      });
    }

    function addTeam() {
      if (teams.length >= maxTeams) return;
      const n = nextTeamNumber++;
      teams.push(n);
      selectedPlayers[n] = [];
      document.getElementById("tradeContainer")
        .insertAdjacentHTML("beforeend", createTeamBox(n));
      attachTeamListeners(n);
      rebuildDestOptions();
      updateReceives();
      updateRemoveButtons();
      updateLayoutMode();
      if (teams.length === maxTeams)
        document.getElementById("addTeamButton").disabled = true;
    }

    function removeTeam(num) {
      if (teams.length <= 2) return;
      teams = teams.filter(t => t !== num);
      delete selectedPlayers[num];
      document.getElementById(`team${num}Box`).remove();
      rebuildDestOptions();
      updateReceives();
      updateRemoveButtons();
      updateLayoutMode();
      if (teams.length < maxTeams)
        document.getElementById("addTeamButton").disabled = false;
    }

    function updateLayoutMode() {
      document.getElementById("tradeContainer")
        .classList.toggle("grid", teams.length >= 3);
    }

    /********** Initialization **********/
    async function initialize() {
      await loadAllPlayers();
      teams.forEach(t => attachTeamListeners(t));
      document.getElementById("addTeamButton").addEventListener("click", addTeam);
      updateRemoveButtons();
      updateLayoutMode();
    }
    initialize();
  </script>

  <!-- Nav‑loader -->
  <script>
    fetch('/nav.html')
      .then(r => r.text())
      .then(html => document.getElementById('nav-placeholder').innerHTML = html)
      .catch(e => console.error('Nav load failed:', e));
  </script>
</body>
</html>

